<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="alarm-form.html">
<link rel="import" href="alarm-view.html">

<dom-module id="alarm-list">
	<template>
		<style>
		</style>
		<template is="dom-if" if="{{ isEditing }}" restamp="true">
			<alarm-form alarm-id="{{ idEditing }}"
				resource-url="{{ resourceUrl }}">
			</alarm-form>
		</template>
		<button on-click="_create">Create</button>
		<template is="dom-repeat" items="{{alarms}}" sort="timeRemaining">
			<alarm-view options="{{ item }}"></alarm-view>
		</template>
		<iron-ajax
			auto
			url="{{ resourceUrl }}"
			handle-as="json"
			on-response="_load"
			debounce-duration="300"></iron-ajax>
	</template>
</dom-module>

<script>
	Polymer({
		is: 'alarm-list',

		properties: {
			isEditing: Boolean,
			idEditing: 0,
			alarms: {
				type: Array,
				value: []
			}
		},

		_load: function (request) {
			this.set('alarms', request.detail.response);
		},

		_create: function () {
			this.idEditing = 0;
			this.isEditing = true;
		},
		
		listeners: {
			'save': 'onFormClose',
			'close': 'onFormClose',
			'edit': 'onEdit',
			'remove': 'onRemove'
		},

		onFormClose: function () {
			this.refresh();
			this.isEditing = false;
			this.idEditing = 0;
		},

		onEdit: function (e) {
			this.idEditing = e.target.get('alarmId');
			this.isEditing = true;
		},

		onRemove: function (e) {
			var id = e.target.get('alarmId');
			fetch(this.resourceUrl + '/' + id, {
				method: 'DELETE',
				headers: this.resourceHeaders
			})
			.then(this.refresh.bind(this))
			.catch(console.error.bind(console))
			;
		},

		// Utility

		timeRemaining: function (a, b) {
			return a.hours > b.hours ? 1 : -1;
		},

		refresh: function () {
			this.querySelector('iron-ajax').generateRequest();
		}
	});
</script>
